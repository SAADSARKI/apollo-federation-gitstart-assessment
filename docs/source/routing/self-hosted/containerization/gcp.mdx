---
title: Deploying GraphOS Router on Google Cloud Platform
subtitle: Deploy router with Google Cloud Run
description: Build and deploy Apollo GraphOS Router or Apollo Router Core to Google Cloud Platform (GCP) with Google Cloud Run.
---

Learn how to deploy the router for development on Google Cloud Platform (GCP) with Cloud Run.

You will:
- Build a router image with a Dockerfile.
- Set up an Azure Container Registry and push your router image to it.
- Create and deploy an Azure Container App for your router.

<Note>

Not deploying to GCP? Try our deployment guides for [AWS](/graphos/routing/self-hosted/containerization/aws) or [Azure](/graphos/routing/self-hosted/containerization/azure).

</Note>

## Prerequisites

Before you start:

1. [Set up a GraphQL API in GraphOS](/graphos/get-started/guides/graphql#step-1-set-up-your-graphql-api).
    - Save your `APOLLO_KEY` and `APOLLO_GRAPH_REF`. You'll need them when deploying the router.
1. Install [Docker](https://www.docker.com/get-started/) locally.
1. Create a new [Google Cloud account](https://cloud.google.com/) or go to an existing account.
1. Install the [gcloud CLI](https://cloud.google.com/sdk/docs/install), if not already installed, and log in to your GCP account.
1. Create a new project in GCP.
    * Choose a project name (for example, `my-project`). Keep this name handy, as you'll need it later to build and run a router image.
1. In GCP, enable [Artifact Registry](https://cloud.google.com/artifact-registry/docs/enable-service) in your project.
    * Create a repository and choose a repository name (for example, `my-repo`). Keep this name handy, as you'll need it later to build and deploy a router image.
1. In GCP Secret Manager, set `APOLLO_KEY` to your graph API key and `APOLLO_GRAPH_REF` to your graph ref. You'll need them later to deploy a router image. 
1. Choose a version of the router to deploy (for example, `v1.61.0`). You'll need it when specifying the router image to deploy.

## Build and push router image

After setting up Docker and GCP, build a router image with custom configuration, then push it to your GCP registry:

1. In a local directory, create a `router.yaml` file and copy-paste the following configuration into the file: 
    
    ```yaml title="router.yaml"
    supergraph:
        listen: 0.0.0.0:4000
    health_check:
        listen: 0.0.0.0:8088
    ```

    Because the router's default HTTP and health check endpoint addresses are localhost and wouldn't be reachable when deployed, edit your `router.yaml` to configure these endpoints to listen to all addresses:  

1. Create a `Dockerfile` file and copy-paste the following into the file, where the container image of your chosen version of router is downloaded, and your customized `router.yaml` configuration file replaces the default router configuration file:

    ```text showLineNumbers=false
    # Use the official Apollo Router Core image as the base.
    # Set the image tag to the desired router version (e.g. v1.61.0)
    FROM ghcr.io/apollographql/router:v1.61.0

    # Replace the default router config with the local, customized router.yaml
    COPY router.yaml /dist/config/router.yaml
    ```

1. From the same local directory, run the following `docker` CLI command to build a new router image. Choose a name and tag for the image, for example `router-gcp:v1.61.0`.
    
    ```bash showLineNumbers=false
    docker buildx build --platform linux/amd64  -t router-gcp:v1.61.0 --load .
    ```

    - Because Cloud Run only supports AMD64-based images, the `docker buildx build --platform linux/amd64` command ensures the image is built for AMD64 and is compatible.  
    - The `--load` option loads the built image to `docker images`.

1. Run `docker images` and validate that your router image was successfully built and loaded.

1. Run `docker tag` to tag the image before pushing it to Artifact Registry. Make sure your tag conforms with Artifact Registry's [naming convention](https://cloud.google.com/artifact-registry/docs/docker/names) (for example, `us-west2-docker.pkg.dev/my-project/my-repo/router-gcp:v1.61.0`).

    ```bash showLineNumbers=false
    docker tag router-gcp:v1.61.0 \
        us-west2-docker.pkg.dev/my-project/my-repo/router-gcp:v1.61.0
    ```

1. Run `docker push` to push the router image to Artifact Registry.

    ```bash showLineNumbers=false
    docker push us-west2-docker.pkg.dev/my-project/my-repo/router-gcp:v1.61.0
    ```

1. Validate the router image has been successfully pushed to Artifact Registry. You can use Google Cloud Console and navigate to your repository in Artifact Registry. You can also use the gcloud CLI and run `gcloud artifacts docker images`. For example:

    ```bash showLineNumbers=false
    gcloud artifacts docker images list us-west2-docker.pkg.dev/my-project/my-repo
    ```

## Configure and deploy router 

With the router image pushed to GCP, you can now configure and deploy it as a Cloud Run service.

You can use either Google Cloud console or gcloud CLI. In either case, you need to gather the following information:

* Name for your deployed router service (for example, `my-router`)
* GCP project name (for example, `my-project`)
* Artifact Registry repo name (for example, `my-repo`)
* GCP region (for example, `us-west2`)
* Full image path (for example, `us-west2-docker.pkg.dev/my-project/my-repo/router-gcp:v1.61.0`) 
* `APOLLO_KEY` and `APOLLO_GRAPH_REF` secrets

### Deploy with Google Cloud console

1. In GCP console for your project, go to Cloud Run and select **Deploy container** > **Service**.
1. On the **Create Service** page, update the following configurations:
    * Set **Container image URL** to your tagged and pushed router image. 
    * Set **Service name** to a name for your deployed router (for example, `my-router`).
    * Set **Region** to your GCP region.
    * Set **Authentication** to **Allow unauthenticated invocations**.
1. On the **Container(s)** > **Edit Container** tab, go to the **Settings** tab and update the following configurations:
    * Set **Container port** to `4000`. This port must match your router's configuration for `supergraph.listen`.
    * Set **Container command** to `/dist/router`.
    * (Optional) if running router in dev mode, set **Container arguments** to `--dev`.
1. Also on the **Container(s)** > **Edit Container** tab, go to the **Variables & Secrets** tab and add the following variables (either as environment variables or referenced secrets):
    * Add `APOLLO_KEY` and set it to your graph API key.
    * Add `APOLLO_GRAPH_REF` and set it to your graph ref.   
1. Click **Deploy** to deploy the router.

### Deploy with gcloud CLI

1. To deploy the router with the gcloud CLI, run the `gloucd run deploy` command, using your configuration info in place of the example info:

    ```bash showLineNumbers=false
    gcloud run deploy my-router \
    --image=us-west2-docker.pkg.dev/my-project/my-repo/router-gcp:v1.61.0 \
    --command=/dist/router \
    --args=--dev \
    --set-secrets=APOLLO_KEY=APOLLO_KEY:latest,APOLLO_GRAPH_REF=APOLLO_GRAPH_REF:latest \
    --region=us-west2 \
    --project=router-container-gcp 
    ```

1. Update traffic to your deployed router by running `gcloud run services update-traffic`:

    ```bash
    gcloud run services update-traffic my-router --to-latest
    ```
    